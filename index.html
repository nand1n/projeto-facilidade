<!doctype html>
<html lang="pt-br">
<head>
Â  <meta charset="utf-8"/>
Â  <meta name="viewport" content="width=device-width, initial-scale=1"/>
Â  <title>MVP ProtÃ³tipo (Local) â€” Login + Admin Users</title>
Â  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
Â  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
Â  <style>
Â  Â  body{background:#f7f9fc}
Â  Â  .hidden{display:none}
Â  Â  button, .btn, .form-control, .form-select { min-height: 44px; }
Â  Â  .nav-tabs .nav-link { padding: .75rem 1rem; }
Â  Â  .thumb { width:31vw; height:31vw; max-width:140px; max-height:140px; object-fit:cover; border-radius:6px; border:2px solid #e5e7eb }
Â  Â  .ok { border-color:#16a34a }
Â  Â  .bad { border-color:#dc2626 }

Â  Â  /* Barra fixa do mobile: por padrÃ£o, vamos esconder via JS quando nÃ£o for rep/instr na aba certa */
Â  Â  @media (max-width: 576px){ #repActionBar { display:block; } #repButtonsInline { display:none; } }
Â  Â  @media (min-width: 577px){ #repActionBar { display:none; } #repButtonsInline { display:flex; gap:.5rem; } }

Â  Â  /* Barra de upload (progresso opcional) */
Â  Â  #upBarWrap{height:8px;background:#eee;border-radius:8px;overflow:hidden;margin-top:8px;display:none}
Â  Â  #upBar{height:100%;width:0%;}
Â  </style>
</head>
<body class="container py-4">

Â  Â  <div id="setupAdminView" class="row justify-content-center hidden">
Â  Â  <div class="col-lg-6">
Â  Â  Â  <div class="card shadow-sm">
Â  Â  Â  Â  <div class="card-body">
Â  Â  Â  Â  Â  <h3 class="h5 mb-3">ConfiguraÃ§Ã£o inicial â€” Criar ADMIN</h3>
Â  Â  Â  Â  Â  <div class="mb-2">
Â  Â  Â  Â  Â  Â  <label class="form-label">Nome</label>
Â  Â  Â  Â  Â  Â  <input id="saNome" class="form-control" placeholder="Seu nome completo">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="mb-2">
Â  Â  Â  Â  Â  Â  <label class="form-label">E-mail (login)</label>
Â  Â  Â  Â  Â  Â  <input id="saEmail" type="email" class="form-control" placeholder="admin@empresa.com">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="mb-2">
Â  Â  Â  Â  Â  Â  <label class="form-label">Senha</label>
Â  Â  Â  Â  Â  Â  <input id="saSenha" type="password" class="form-control" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="alert alert-warning">
Â  Â  Â  Â  Â  Â  Este ADMIN ficarÃ¡ salvo apenas neste navegador (uso de testes locais).
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="d-grid">
Â  Â  Â  Â  Â  Â  <button id="btnCriarAdmin" class="btn btn-primary">Criar ADMIN</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  Â  <div id="loginView" class="row justify-content-center hidden">
Â  Â  <div class="col-lg-6">
Â  Â  Â  <div class="card shadow-sm">
Â  Â  Â  Â  <div class="card-body">
Â  Â  Â  Â  Â  <h3 class="h5 mb-3">MVP Portal â€” Acesso</h3>
Â  Â  Â  Â  Â  <div class="mb-2">
Â  Â  Â  Â  Â  Â  <label class="form-label">E-mail</label>
Â  Â  Â  Â  Â  Â  <input id="email" class="form-control" placeholder="seu@empresa.com">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="mb-2">
Â  Â  Â  Â  Â  Â  <label class="form-label">Senha</label>
Â  Â  Â  Â  Â  Â  <input id="password" type="password" class="form-control" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="mb-2">
Â  Â  Â  Â  Â  Â  <label class="form-label">Perfil</label>
Â  Â  Â  Â  Â  Â  <select id="role" class="form-select">
Â  Â  Â  Â  Â  Â  Â  <option value="rep">Representante</option>
Â  Â  Â  Â  Â  Â  Â  <option value="instr">Instrumentador</option>
Â  Â  Â  Â  Â  Â  Â  <option value="log">LogÃ­stica</option>
Â  Â  Â  Â  Â  Â  Â  <option value="ana">Analista</option>
Â  Â  Â  Â  Â  Â  Â  <option value="adm">Admin</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="d-grid gap-2">
Â  Â  Â  Â  Â  Â  <button id="btnLogin" class="btn btn-primary">Entrar</button>
Â  Â  Â  Â  Â  Â  <button id="btnClear" class="btn btn-outline-secondary">Limpar dados locais</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <small class="text-muted d-block mt-2">ProtÃ³tipo local (dados no navegador).</small>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  Â  <div id="appView" class="hidden">
Â  Â  <nav class="navbar navbar-expand-lg bg-white border rounded px-3 mb-3">
Â  Â  Â  <a class="navbar-brand" href="#">MVP Portal - Teste</a>
Â  Â  Â  <div class="ms-auto">
Â  Â  Â  Â  <span id="userBadge" class="badge text-bg-secondary me-2"></span>
Â  Â  Â  Â  <button id="btnLogout" class="btn btn-outline-danger btn-sm">Sair</button>
Â  Â  Â  </div>
Â  Â  </nav>

Â  Â  Â  Â  <ul class="nav nav-tabs mb-3" id="tabs">
Â  Â  Â  <li class="nav-item repTab"><button class="nav-link" data-target="#tab-rep">Representante</button></li>
Â  Â  Â  <li class="nav-item logTab"><button class="nav-link" data-target="#tab-log">LogÃ­stica</button></li>
Â  Â  Â  <li class="nav-item anaTab"><button class="nav-link" data-target="#tab-ana">Analista</button></li>
Â  Â  Â  <li class="nav-item admTab"><button class="nav-link" data-target="#tab-adm">Gerenciar UsuÃ¡rios (ADMIN)</button></li>
Â  Â  </ul>

Â  Â  Â  Â  <div id="tab-rep" class="card shadow-sm p-3 hidden">
Â  Â  Â  <h5>Envio rÃ¡pido (teste)</h5>
Â  Â  Â  <div class="row g-2">
Â  Â  Â  Â  <div class="col-md-3"><input id="inpPaciente" class="form-control" placeholder="Paciente (iniciais/ID)" autocomplete="off"></div>
Â  Â  Â  Â  <div class="col-md-3"><input id="inpMedico" class="form-control" placeholder="MÃ©dico" autocomplete="off"></div>
Â  Â  Â  Â  <div class="col-md-3"><input id="inpHospital" class="form-control" placeholder="Hospital" autocomplete="off"></div>
Â  Â  Â  Â  <div class="col-md-3"><input id="inpConvenio" class="form-control" placeholder="ConvÃªnio" autocomplete="off"></div>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="mt-3 d-flex gap-2 flex-wrap">
Â  Â  Â  Â  <button id="btnCamera" type="button" class="btn btn-outline-primary">Abrir cÃ¢mera</button>
Â  Â  Â  Â  <button id="btnGaleria" type="button" class="btn btn-outline-secondary">Escolher da galeria</button>
Â  Â  Â  Â  <small class="text-muted ms-1 align-self-center">AtÃ© 5 imagens. ValidaÃ§Ã£o simples antes do PDF.</small>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <input id="fileCamera" type="file" accept="image/*;capture=camera" capture="environment" class="d-none">
Â  Â  Â  <input id="fileGallery" type="file" accept="image/*" multiple class="d-none">

Â  Â  Â  <div id="thumbs" class="mt-3 d-flex gap-2 flex-wrap"></div>

Â  Â  Â  <div id="repButtonsInline" class="mt-3">
Â  Â  Â  Â  <button id="btnGenPdf" class="btn btn-secondary">Gerar PDF</button>
Â  Â  Â  Â  <button id="btnEnviar" class="btn btn-success" disabled>Enviar (simulado)</button>
Â  Â  Â  </div>

Â  Â  Â  <div id="upBarWrap"><div id="upBar"></div></div>

Â  Â  Â  <div id="repMsg" class="mt-3"></div>
Â  Â  </div>

Â  Â  Â  Â  <div id="repActionBar" class="d-sm-none fixed-bottom bg-white border-top p-2">
Â  Â  Â  <div class="container px-0">
Â  Â  Â  Â  <div class="d-flex gap-2">
Â  Â  Â  Â  Â  <button id="btnGenPdfMobile" class="btn btn-secondary flex-fill">Gerar PDF</button>
Â  Â  Â  Â  Â  <button id="btnEnviarMobile" class="btn btn-success flex-fill" disabled>Enviar</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div id="tab-log" class="card shadow-sm p-3 hidden">
Â  Â  Â  <h5>Painel - LogÃ­stica</h5>
Â  Â  Â  <div class="mb-2 d-flex gap-2">
Â  Â  Â  Â  <input id="fPaciente" class="form-control" placeholder="Filtrar por paciente">
Â  Â  Â  Â  <input id="fMedico" class="form-control" placeholder="MÃ©dico">
Â  Â  Â  Â  <input id="fProto" class="form-control" placeholder="Protocolo">
Â  Â  Â  Â  <select id="fStatus" class="form-select">
Â  Â  Â  Â  Â  <option value="TODOS">Todos</option>
Â  Â  Â  Â  Â  <option value="Recebido">Em andamento</option>
Â  Â  Â  Â  Â  <option value="Finalizado">Finalizados</option>
Â  Â  Â  Â  Â  <option value="Resolvido">Resolvidos</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <button id="btnFilter" class="btn btn-outline-primary">Filtrar</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="table-responsive" style="max-height:320px;">
Â  Â  Â  Â  <table class="table table-sm align-middle">
Â  Â  Â  Â  Â  <thead><tr><th>Protoc.</th><th>Paciente</th><th>MÃ©dico</th><th>Hospital</th><th>ConvÃªnio</th><th>Status</th><th>AÃ§Ãµes</th></tr></thead>
Â  Â  Â  Â  Â  <tbody id="logTable"></tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </div>
Â  Â  Â  <small class="text-muted">Finalizar â†’ libera para Analista.</small>
Â  Â  </div>

Â  Â  Â  Â  <div id="tab-ana" class="card shadow-sm p-3 hidden">
Â  Â  Â  <h5>Painel - Analista</h5>
Â  Â  Â  <div class="mb-2 d-flex gap-2">
Â  Â  Â  Â  <input id="aPaciente" class="form-control" placeholder="Filtrar por paciente">
Â  Â  Â  Â  <input id="aMedico" class="form-control" placeholder="MÃ©dico">
Â  Â  Â  Â  <input id="aProto" class="form-control" placeholder="Protocolo">
Â  Â  Â  Â  <select id="aStatus" class="form-select">
Â  Â  Â  Â  Â  <option value="TODOS">Todos</option>
Â  Â  Â  Â  Â  <option value="Finalizado" selected>Finalizados</option>
Â  Â  Â  Â  Â  <option value="Resolvido">Resolvidos</option>
Â  Â  Â  Â  Â  <option value="Recebido">Em andamento</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <button id="btnFilterAna" class="btn btn-outline-primary">Filtrar</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="table-responsive" style="max-height:320px;">
Â  Â  Â  Â  <table class="table table-sm align-middle">
Â  Â  Â  Â  Â  <thead><tr><th>Protoc.</th><th>Paciente</th><th>MÃ©dico</th><th>Hospital</th><th>ConvÃªnio</th><th>Status</th><th>AÃ§Ãµes</th></tr></thead>
Â  Â  Â  Â  Â  <tbody id="anaTable"></tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </div>
Â  Â  Â  <small class="text-muted">Marcar Resolvido quando concluÃ­do.</small>
Â  Â  </div>

Â  Â  Â  Â  <div id="tab-adm" class="card shadow-sm p-3 hidden">
Â  Â  Â  <h5>Gerenciar UsuÃ¡rios (Local)</h5>
Â  Â  Â  <div class="row g-2">
Â  Â  Â  Â  <div class="col-md-4"><input id="uNome" class="form-control" placeholder="Nome completo"></div>
Â  Â  Â  Â  <div class="col-md-3"><input id="uEmail" type="email" class="form-control" placeholder="email@empresa.com"></div>
Â  Â  Â  Â  <div class="col-md-3"><input id="uSenha" type="password" class="form-control" placeholder="Senha"></div>
Â  Â  Â  Â  <div class="col-md-2">
Â  Â  Â  Â  Â  <select id="uRole" class="form-select">
Â  Â  Â  Â  Â  Â  <option value="rep">Representante</option>
Â  Â  Â  Â  Â  Â  <option value="instr">Instrumentador</option>
Â  Â  Â  Â  Â  Â  <option value="log">LogÃ­stica</option>
Â  Â  Â  Â  Â  Â  <option value="ana">Analista</option>
Â  Â  Â  Â  Â  Â  <option value="adm">Admin</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="mt-2 d-flex gap-2">
Â  Â  Â  Â  <button id="btnCriarUsuario" class="btn btn-primary">Criar UsuÃ¡rio</button>
Â  Â  Â  Â  <button id="btnExportar" class="btn btn-outline-secondary">Exportar (JSON)</button>
Â  Â  Â  Â  <label class="btn btn-outline-secondary mb-0">
Â  Â  Â  Â  Â  Importar (JSON) <input id="inpImportar" type="file" accept="application/json" hidden>
Â  Â  Â  Â  </label>
Â  Â  Â  </div>
Â  Â  Â  <hr>
Â  Â  Â  <div class="table-responsive" style="max-height:320px;">
Â  Â  Â  Â  <table class="table table-sm align-middle">
Â  Â  Â  Â  Â  <thead><tr><th>Nome</th><th>E-mail</th><th>FunÃ§Ã£o</th><th>Status</th><th>AÃ§Ãµes</th></tr></thead>
Â  Â  Â  Â  Â  <tbody id="usersTable"></tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </div>
Â  Â  Â  <small class="text-muted">Dados ficam no navegador (localStorage). Para testar, Ã© perfeito.</small>
Â  Â  </div>

Â  Â  <div id="downloadArea" class="mt-3"></div>
Â  </div>

<script>

window.addEventListener('unhandledrejection', (ev)=>{
Â  console.error('Unhandled promise rejection:', ev.reason);
Â  // garante que ao menos alguma tela apareÃ§a
Â  if (document.getElementById('loginView').classList.contains('hidden') &&
Â  Â  Â  document.getElementById('setupAdminView').classList.contains('hidden') &&
Â  Â  Â  document.getElementById('appView').classList.contains('hidden')) {
Â  Â  show('loginView', true); // mostra login para nÃ£o ficar branco
Â  }
});

/* ======= STORAGE KEYS ======= */
const STORAGE_USERS = 'mvp_users_v1';
const STORAGE_DOCSÂ  = 'mvp_docs_v1';
window._pdfStore = window._pdfStore || {}; // protocolo -> blobURL (apenas sessÃ£o)

/* ======= UTILS ======= */
function saveJSON(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }
function loadJSON(key){ try { return JSON.parse(localStorage.getItem(key) || '[]'); } catch { return []; } }
// Cache local em memÃ³ria (para renderizaÃ§Ã£o)
let _usersCache = [];
let _docsCacheÂ  = [];

// === USUÃRIOS (REMOTE) ===
async function fetchUsers() {
Â  try {
Â  Â  const res = await fetch('/api/users', { headers: { 'accept': 'application/json' } });
Â  Â  if (!res.ok) { console.error('users API status', res.status); _usersCache = []; return _usersCache; }
Â  Â  // protege caso volte HTML/erro
Â  Â  const text = await res.text();
Â  Â  try { _usersCache = JSON.parse(text); } catch { console.error('users JSON invÃ¡lido:', text.slice(0,120)); _usersCache = []; }
Â  } catch (e) {
Â  Â  console.error('users fetch falhou:', e);
Â  Â  _usersCache = [];
Â  }
Â  return _usersCache;
}
function users() {Â  Â  Â  Â  Â  Â // getter sÃ­ncrono
Â  return _usersCache;
}

async function createUserRemote({ nome, email, senha, role }) {
Â  const res = await fetch('/api/users', {
Â  Â  method: 'POST',
Â  Â  headers: { 'content-type': 'application/json' },
Â  Â  body: JSON.stringify({ nome, email, senha, role, ativo: true })
Â  });
Â  if (!res.ok) throw new Error((await res.json()).error || 'Erro ao criar usuÃ¡rio');
Â  const u = await res.json();
Â  _usersCache.push(u);Â  Â  Â  Â // mantÃ©m cache
Â  return u;
}

async function toggleUserActive(email){
Â  const u = _usersCache.find(x => x.email.toLowerCase() === email.toLowerCase());
Â  const patch = { ativo: !(u?.ativo !== false) };
Â  const res = await fetch('/api/users', {
Â  Â  method: 'PUT',
Â  Â  headers: { 'content-type': 'application/json' },
Â  Â  body: JSON.stringify({ email, patch })
Â  });
Â  if (!res.ok) throw new Error((await res.json()).error || 'Erro ao atualizar usuÃ¡rio');
Â  const updated = await res.json();
Â  const i = _usersCache.findIndex(x => x.email.toLowerCase() === email.toLowerCase());
Â  if (i >= 0) _usersCache[i] = updated;
Â  return updated;
}


// === DOCUMENTOS (REMOTE) ===
async function fetchDocs(){
Â  const res = await fetch('/api/docs');
Â  _docsCache = await res.json();
Â  return _docsCache;
}
function docs(){Â  Â  Â  Â  Â  Â  Â // getter sÃ­ncrono
Â  return _docsCache;
}

async function addDocRemote(entry){
Â  const res = await fetch('/api/docs', {
Â  Â  method: 'POST',
Â  Â  headers: { 'content-type': 'application/json' },
Â  Â  body: JSON.stringify(entry)
Â  });
Â  if (!res.ok) throw new Error((await res.json()).error || 'Erro ao salvar documento');
Â  const saved = await res.json();
Â  _docsCache.unshift(saved); // mantÃ©m cache
Â  return saved;
}
async function patchDocRemote(proto, patch){
Â  const res = await fetch('/api/docs', {
Â  Â  method: 'PATCH',
Â  Â  headers: { 'content-type': 'application/json' },
Â  Â  body: JSON.stringify({ proto, patch })
Â  });
Â  if (!res.ok) throw new Error((await res.json()).error || 'Erro ao atualizar documento');
Â  const saved = await res.json();
Â  const i = _docsCache.findIndex(x => x.proto === proto);
Â  if (i >= 0) _docsCache[i] = saved;
Â  return saved;
}

// (se existir sua funÃ§Ã£o setDocs antiga, simplifique-a para manter o cache)
function setDocs(d){ _docsCache = d; }


function newProtocol(){ return `ASER-${new Date().getFullYear()}-${Math.floor(Math.random()*1e6).toString().padStart(6,'0')}`; }

function statusBadge(s){
Â  const cls = s==='Resolvido' ? 'text-bg-success' : s==='Finalizado' ? 'text-bg-primary' : 'text-bg-secondary';
Â  return `<span class="badge ${cls}">${s}</span>`;
}

/* ======= VIEW CONTROL ======= */
function show(el, on=true){ document.getElementById(el).classList.toggle('hidden', !on); }

async function boot(){
Â  try{
Â  Â  const list = await users().catch(()=>[]);
Â  Â  const hasUsers = Array.isArray(list) && list.length > 0;
Â  Â  show('setupAdminView', !hasUsers);
Â  Â  show('loginView', hasUsers);
Â  Â  show('appView', false);
Â  }catch(e){
Â  Â  console.error('Falha no boot:', e);
Â  Â  // Fallback seguro: mostra setup para nÃ£o ficar tela branca
Â  Â  show('setupAdminView', true);
Â  Â  show('loginView', false);
Â  Â  show('appView', false);
Â  }
}


boot();

/* ======= SETUP ADMIN ======= */
/* ======= SETUP ADMIN ======= */
document.getElementById('btnCriarAdmin').addEventListener('click', async ()=>{
Â  const nome = document.getElementById('saNome').value.trim();
Â  const email= document.getElementById('saEmail').value.trim();
Â  const senha= document.getElementById('saSenha').value.trim();
Â  if(!nome||!email||!senha){ alert('Preencha todos os campos.'); return; }

Â  const list = await users(); // busca na KV
Â  if(Array.isArray(list) && list.some(x=>x.email.toLowerCase()===email.toLowerCase())){
Â  Â  alert('JÃ¡ existe usuÃ¡rio com este e-mail.');
Â  Â  return;
Â  }

Â  await createUserRemote({ nome, email, senha, role:'adm' });

Â  alert('ADMIN criado com sucesso! FaÃ§a login.');
Â  show('setupAdminView', false);
Â  show('loginView', true);
});



/* ======= LOGIN ======= */
async function setView(user){
Â  show('loginView', false);
Â  show('setupAdminView', false);
Â  show('appView', true);

Â  const roleLabel = user.role==='rep' ? 'REP'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â : user.role==='instr' ? 'INSTR'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â : user.role==='log' ? 'LOG'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â : user.role==='ana' ? 'ANA' : 'ADMIN';
Â  document.getElementById('userBadge').textContent = `${user.nome} â€¢ ${roleLabel}`;

Â  document.querySelectorAll('.repTab').forEach(el=>el.classList.toggle('hidden', !(user.role==='rep'||user.role==='instr')));
Â  document.querySelectorAll('.logTab').forEach(el=>el.classList.toggle('hidden', user.role!=='log'));
Â  document.querySelectorAll('.anaTab').forEach(el=>el.classList.toggle('hidden', user.role!=='ana'));
Â  document.querySelectorAll('.admTab').forEach(el=>el.classList.toggle('hidden', user.role!=='adm'));

Â  if(user.role==='rep'||user.role==='instr') showTab('#tab-rep');
Â  else if(user.role==='log') showTab('#tab-log');
Â  else if(user.role==='ana') showTab('#tab-ana');
Â  else showTab('#tab-adm');

Â  // ðŸ”‘ carrega os documentos da nuvem (KV) antes de desenhar as tabelas

await fetchDocs();


Â  renderTables();
Â  renderUsersTable();
Â  updateActionBarVisibility();
}

document.getElementById('btnLogin').addEventListener('click', async ()=>{
Â  const email = document.getElementById('email').value.trim();
Â  const passÂ  = document.getElementById('password').value.trim();
Â  const selectedRole = document.getElementById('role').value;

Â  if(!email||!pass){ alert('Preencha e-mail e senha'); return; }

Â  const list = await users(); // <- agora sim
Â  const u = Array.isArray(list) ? list.find(x =>
Â  Â  x.email.toLowerCase()===email.toLowerCase() && x.senha===pass && x.ativo!==false
Â  ) : null;

Â  if(!u){ alert('Login ou senha incorretos!'); return; }
Â  if(u.role !== selectedRole){ alert('Perfil incompatÃ­vel com seus dados!'); return; }

Â  const user = { email:u.email, role:u.role, nome:u.nome };
Â  sessionStorage.setItem('mvp_user', JSON.stringify(user));
Â  setView(user);
});


document.getElementById('btnLogout').addEventListener('click', ()=>{
Â  sessionStorage.removeItem('mvp_user');
Â  show('appView', false); show('loginView', true);
});

document.getElementById('btnClear').addEventListener('click', ()=>{
Â  if(!confirm('Isso apaga TODOS os dados locais (usuÃ¡rios, documentos). Continuar?')) return;
Â  localStorage.removeItem(STORAGE_USERS);
Â  localStorage.removeItem(STORAGE_DOCS);
Â  window._pdfStore = {};
Â  sessionStorage.removeItem('mvp_user');
Â  location.reload();
});

/* ======= TABS ======= */
function showTab(sel){
Â  document.querySelectorAll('[id^="tab-"]').forEach(div=>div.classList.add('hidden'));
Â  document.querySelector(sel).classList.remove('hidden');
Â  document.querySelectorAll('#tabs .nav-link').forEach(b=>b.classList.remove('active'));
Â  document.querySelector(`#tabs .nav-link[data-target="${sel}"]`)?.classList.add('active');
Â  updateActionBarVisibility(); // <- barra fixa sÃ³ quando cabÃ­vel
}
document.querySelectorAll('#tabs .nav-link').forEach(btn=>btn.addEventListener('click', ()=> showTab(btn.dataset.target)));

/* ======= Controle da barra fixa (mobile) ======= */
function updateActionBarVisibility() {
Â  const bar = document.getElementById('repActionBar');
Â  if (!bar) return;
Â  const user = JSON.parse(sessionStorage.getItem('mvp_user') || 'null');
Â  const isRepRole = user && (user.role === 'rep' || user.role === 'instr');
Â  const active = document.querySelector('#tabs .nav-link.active');
Â  const inRepTab = !!active && active.dataset.target === '#tab-rep';
Â  bar.style.display = (isRepRole && inRepTab) ? '' : 'none';
}

/* ======= REP â€” imagens/PDF ======= */
function toCanvas(img, maxSide=1600){
Â  const cvs=document.createElement('canvas'); let{width,height}=img;
Â  const scale=Math.min(1, maxSide/Math.max(width,height)); width=Math.round(width*scale); height=Math.round(height*scale);
Â  cvs.width=width;cvs.height=height; cvs.getContext('2d').drawImage(img,0,0,width,height); return cvs;
}
function grayscaleData(ctx,w,h){ const d=ctx.getImageData(0,0,w,h).data, g=new Float32Array(w*h); for(let i=0,j=0;i<d.length;i+=4,j++) g[j]=0.299*d[i]+0.587*d[i+1]+0.114*d[i+2]; return {gray:g,w,h}; }
function laplacianVariance(gray,w,h){ if(w<3||h<3)return 0; let s=0, ss=0, c=0; const idx=(x,y)=>y*w+x;
Â  for(let y=1;y<h-1;y++)for(let x=1;x<w-1;x++){ const L=(gray[idx(x-1,y)]+gray[idx(x+1,y)]+gray[idx(x,y-1)]+gray[idx(x,y+1)]-4*gray[idx(x,y)]); s+=L; ss+=L*L; c++; }
Â  const m=s/c; return ss/c - m*m;
}
function luminanceStd(gray){ let s=0,ss=0,n=gray.length; for(let i=0;i<n;i++){ const v=gray[i]; s+=v; ss+=v*v; } const m=s/n; return Math.sqrt(ss/n - m*m); }
function fileToImage(file){ return new Promise((res,rej)=>{ const url=URL.createObjectURL(file); const img=new Image(); img.onload=()=>{ URL.revokeObjectURL(url); res(img); }; img.onerror=rej; img.src=url; }); }

let selectedFiles=[];
function handleFiles(fileList){
Â  const toArr=[...fileList];
Â  const all = selectedFiles.map(x=>x.file).concat(toArr);Â  Â  Â  Â // acumula chamadas (cÃ¢mera + galeria)
Â  const limited = all.slice(0,5);Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // limita a 5
Â  selectedFiles=[];Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // recalcula tudo
Â  const thumbs=document.getElementById('thumbs'); thumbs.innerHTML='';

Â  (async ()=>{
Â  Â  for(const f of limited){
Â  Â  Â  const img=await fileToImage(f); const cvs=toCanvas(img,1600); const ctx=cvs.getContext('2d');
Â  Â  Â  const {gray,w,h}=grayscaleData(ctx,cvs.width,cvs.height); const blurVar=laplacianVariance(gray,w,h); const lumStd=luminanceStd(gray);
Â  Â  Â  const ok=blurVar>=100 && lumStd>=18; const dataUrl=cvs.toDataURL('image/jpeg',0.75);
Â  Â  Â  selectedFiles.push({file:f,dataUrl,ok,reason:ok?'OK':(blurVar<100?'Borrada':'Baixa luz')});
Â  Â  Â  const imgEl=document.createElement('img'); imgEl.src=dataUrl; imgEl.className='thumb '+(ok?'ok':'bad'); imgEl.title=selectedFiles[selectedFiles.length-1].reason; thumbs.appendChild(imgEl);
Â  Â  }
Â  Â  // desabilita envio atÃ© gerar PDF
Â  Â  document.getElementById('btnEnviar').disabled=true; document.getElementById('btnEnviarMobile').disabled=true;
Â  })();
}

// BotÃµes -> inputs escondidos
document.getElementById('btnCamera').addEventListener('click', ()=> document.getElementById('fileCamera').click());
document.getElementById('btnGaleria').addEventListener('click', ()=> document.getElementById('fileGallery').click());

// Listeners dos inputs
document.getElementById('fileCamera').addEventListener('change', (e)=>{
Â  if(!e.target.files?.length) return;
Â  handleFiles(e.target.files);Â  Â  Â  // iOS pode mandar sÃ³ 1 â€” ok
Â  e.target.value='';Â  Â  Â  Â  Â  Â  Â  Â  // permite abrir cÃ¢mera de novo
});
document.getElementById('fileGallery').addEventListener('change', (e)=>{
Â  if(!e.target.files?.length) return;
Â  handleFiles(e.target.files);Â  Â  Â  // permite mÃºltiplas no iOS/Android
Â  e.target.value='';Â  Â  Â  Â  Â  Â  Â  Â  // permite reabrir e escolher mais
});

// iOS: se por acaso algum navegador ignorar mÃºltiplas na galeria, garantimos atributos corretos
(function fixIOSFileInput(){
Â  const ua = navigator.userAgent || navigator.vendor || window.opera;
Â  const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
Â  if (!isIOS) return;
Â  const g = document.getElementById('fileGallery');
Â  if (g){ g.removeAttribute('capture'); g.setAttribute('accept','image/*'); g.setAttribute('multiple','multiple'); }
})();

async function generatePdf(){
Â  if(selectedFiles.length===0){ alert('Selecione 1 a 5 imagens'); return false; }
Â  const { jsPDF }=window.jspdf; const pdf=new jsPDF({orientation:'p',unit:'pt',format:'a4'}); const pageW=pdf.internal.pageSize.getWidth(); const pageH=pdf.internal.pageSize.getHeight();
Â  for(let i=0;i<selectedFiles.length;i++){
Â  Â  if(i>0) pdf.addPage(); const img=new Image(); await new Promise(r=>{ img.onload=r; img.src=selectedFiles[i].dataUrl; });
Â  Â  const margin=36; const maxW=pageW-margin*2, maxH=pageH-margin*2; let w=img.width,h=img.height; const scale=Math.min(maxW/w,maxH/h); w*=scale; h*=scale;
Â  Â  pdf.addImage(selectedFiles[i].dataUrl,'JPEG',(pageW-w)/2,(pageH-h)/2,w,h);
Â  }
Â  const blob=pdf.output('blob'); const url=URL.createObjectURL(blob); window._lastPdfBlob=blob; window._lastPdfUrl=url;
Â  document.getElementById('repMsg').innerHTML=`<div class="alert alert-info">PDF gerado (${selectedFiles.length} pÃ¡ginas). <a href="${url}" target="_blank" class="btn btn-sm btn-outline-secondary ms-2">Abrir</a> <a href="${url}" download="dossie.pdf" class="btn btn-sm btn-outline-primary ms-1">Baixar</a></div>`;
Â  document.getElementById('btnEnviar').disabled=false; document.getElementById('btnEnviarMobile').disabled=false; return true;
}
document.getElementById('btnGenPdf').addEventListener('click', generatePdf);
document.getElementById('btnGenPdfMobile').addEventListener('click', ()=>document.getElementById('btnGenPdf').click());

/* ======= Upload para Blob (com barra de progresso) ======= */
async function uploadPdfToBlob(protoOrName, blob){
Â  const buffer = await blob.arrayBuffer();
Â  const filename = `${protoOrName}.pdf`;

Â  const xhr = new XMLHttpRequest();
Â  const urlÂ  = '/api/upload';

Â  const p = new Promise((resolve, reject)=>{
Â  Â  xhr.onreadystatechange = () => {
Â  Â  Â  if (xhr.readyState === 4) {
Â  Â  Â  Â  document.getElementById('upBarWrap').style.display = 'none';
Â  Â  Â  Â  document.getElementById('upBar').style.width = '0%';
Â  Â  Â  Â  if (xhr.status >= 200 && xhr.status < 300) {
Â  Â  Â  Â  Â  resolve(JSON.parse(xhr.responseText)); // {url}
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  reject(new Error(xhr.responseText || 'Falha no upload'));
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  };
Â  Â  xhr.upload.onprogress = (ev)=>{
Â  Â  Â  if (!ev.lengthComputable) return;
Â  Â  Â  const pct = Math.round((ev.loaded / ev.total) * 100);
Â  Â  Â  const wrap = document.getElementById('upBarWrap');
Â  Â  Â  const barÂ  = document.getElementById('upBar');
Â  Â  Â  wrap.style.display = 'block';
Â  Â  Â  bar.style.width = pct + '%';
Â  Â  Â  bar.style.background = pct < 50 ? '#f59e0b' : (pct < 100 ? '#3b82f6' : '#10b981');
Â  Â  };
Â  Â  xhr.open('POST', url, true);
Â  Â  xhr.setRequestHeader('content-type', 'application/pdf');
Â  Â  xhr.setRequestHeader('x-filename', encodeURIComponent(filename));
Â  Â  xhr.send(buffer);
Â  });

Â  const data = await p; // { url }
Â  return data.url;
}

/* ======= Envio: registra + sobe PDF + fallback local ======= */
function doSend(){
Â  if(!window._lastPdfBlob){ alert('Gere o PDF primeiro'); return; }
Â  const paciente=document.getElementById('inpPaciente').value.trim()||'ID-S/ NOME';
Â  const medico=document.getElementById('inpMedico').value.trim()||'â€”';
Â  const hospital=document.getElementById('inpHospital').value.trim()||'â€”';
Â  const convenio=document.getElementById('inpConvenio').value.trim()||'â€”';

Â  const proto=newProtocol();

Â  // nome de arquivo seguro: paciente + protocolo
Â  const safe = (s)=> s.replace(/[^a-z0-9-_]+/gi,'_').slice(0,50);
Â  const nomeBase = `${safe(paciente)}_${proto}`;

Â  let publicUrl = null;
Â  (async () => {
Â  Â  try {
Â  Â  Â  // trava botÃµes enquanto envia
Â  Â  Â  document.getElementById('btnEnviar').disabled=true;Â 
Â  Â  Â  document.getElementById('btnEnviarMobile').disabled=true;
Â  Â  Â  document.getElementById('repMsg').innerHTML = '<div class="alert alert-secondary">Enviandoâ€¦ aguarde.</div>';

Â  Â  Â  publicUrl = await uploadPdfToBlob(nomeBase, window._lastPdfBlob);
Â  Â  } catch (e) {
Â  Â  Â  console.error('Falha no upload do PDF para o Blob:', e);
Â  Â  Â  // segue com o PDF local na sessÃ£o
Â  Â  }

Â  Â  const entry = {
Â  Â  Â  proto, paciente, medico, hospital, convenio,
Â  Â  Â  status: 'Recebido',
Â  Â  Â  createdAt: new Date().toISOString(),
Â  Â  Â  url: publicUrl || null
Â  Â  };
Â  Â  await addDocRemote(entry);

Â  Â  const blobUrl=URL.createObjectURL(window._lastPdfBlob);
Â  Â  window._pdfStore[proto]=blobUrl;

Â  Â  selectedFiles=[]; document.getElementById('thumbs').innerHTML='';Â 
Â  Â  document.getElementById('repMsg').innerHTML=`<div class="alert alert-success">Enviado! Protocolo: <strong>${proto}</strong></div>`;
Â  Â  document.getElementById('inpPaciente').value=''; document.getElementById('inpMedico').value=''; document.getElementById('inpHospital').value=''; document.getElementById('inpConvenio').value='';
Â  Â  await docs(); renderTables();
Â  })();
}
document.getElementById('btnEnviar').addEventListener('click', doSend);
document.getElementById('btnEnviarMobile').addEventListener('click', ()=>document.getElementById('btnEnviar').click());

/* ======= TABELAS + FILTROS ======= */
function renderTables(){
Â  const d=_docsCache;

Â  // LogÃ­stica
Â  const logTbody=document.getElementById('logTable'); logTbody.innerHTML='';
Â  d.filter(x=>x.status!=='Resolvido').forEach(x=>{
Â  Â  const tr=document.createElement('tr');
Â  Â  tr.innerHTML=`<td>${x.proto}</td><td>${x.paciente}</td><td>${x.medico}</td><td>${x.hospital}</td><td>${x.convenio}</td><td>${statusBadge(x.status)}</td><td></td>`;
Â  Â  const td=tr.querySelector('td:last-child');

Â  Â  const btnView=document.createElement('button');Â 
Â  Â  btnView.className='btn btn-sm btn-outline-secondary me-1';Â 
Â  Â  btnView.textContent='Ver PDF';

Â  Â  // LINK ONLINE (se existir)
Â  Â  if (x.url) {
Â  Â  Â  const aOnline = document.createElement('a');
Â  Â  Â  aOnline.href = x.url;
Â  Â  Â  aOnline.target = '_blank';
Â  Â  Â  aOnline.className = 'btn btn-sm btn-outline-success me-1';
Â  Â  Â  aOnline.textContent = 'Ver PDF (online)';
Â  Â  Â  td.appendChild(aOnline);
Â  Â  }

Â  Â  // DOWNLOAD local com fallback online
Â  Â  btnView.onclick=()=>{Â 
Â  Â  Â  let url = window._pdfStore[x.proto];Â 
Â  Â  Â  if(!url && x.url){ window.open(x.url, '_blank'); return; }
Â  Â  Â  if(!url){ alert('PDF nÃ£o encontrado nesta sessÃ£o. Use "Ver PDF (online)".'); return; }
Â  Â  Â  const a = document.createElement('a');
Â  Â  Â  a.href = url;
Â  Â  Â  a.download = `${x.paciente}_${x.proto}.pdf`;
Â  Â  Â  document.body.appendChild(a);
Â  Â  Â  a.click();
Â  Â  Â  document.body.removeChild(a);
Â  Â  };
Â  Â  td.appendChild(btnView);

Â  Â  if(x.status==='Recebido'){
Â  Â  Â  const btnFin=document.createElement('button');Â 
Â  Â  Â  btnFin.className='btn btn-sm btn-success';Â 
Â  Â  Â  btnFin.textContent='Finalizar';Â 
Â  Â  Â  btnFin.onclick=async ()=>{ await patchDocRemote(x.proto,{status:'Finalizado'}); await docs(); renderTables(); };Â 
Â  Â  Â  td.appendChild(btnFin);
Â  Â  }
Â  Â  logTbody.appendChild(tr);
Â  });

Â  // Analista
Â  const anaTbody=document.getElementById('anaTable'); anaTbody.innerHTML='';
Â  d.filter(x=>x.status==='Finalizado').forEach(x=>{
Â  Â  const tr=document.createElement('tr');
Â  Â  tr.innerHTML=`<td>${x.proto}</td><td>${x.paciente}</td><td>${x.medico}</td><td>${x.hospital}</td><td>${x.convenio}</td><td>${statusBadge(x.status)}</td><td></td>`;
Â  Â  const td=tr.querySelector('td:last-child');

Â  Â  const btnView=document.createElement('button');Â 
Â  Â  btnView.className='btn btn-sm btn-outline-secondary me-1';Â 
Â  Â  btnView.textContent='Ver PDF';

Â  Â  if (x.url) {
Â  Â  Â  const aOnline = document.createElement('a');
Â  Â  Â  aOnline.href = x.url;
Â  Â  Â  aOnline.target = '_blank';
Â  Â  Â  aOnline.className = 'btn btn-sm btn-outline-success me-1';
Â  Â  Â  aOnline.textContent = 'Ver PDF (online)';
Â  Â  Â  td.appendChild(aOnline);
Â  Â  }

Â  Â  btnView.onclick=()=>{Â 
Â  Â  Â  let url = window._pdfStore[x.proto];Â 
Â  Â  Â  if(!url && x.url){ window.open(x.url, '_blank'); return; }
Â  Â  Â  if(!url){ alert('PDF nÃ£o encontrado nesta sessÃ£o. Use "Ver PDF (online)".'); return; }
Â  Â  Â  const a = document.createElement('a');
Â  Â  Â  a.href = url;
Â  Â  Â  a.download = `${x.paciente}_${x.proto}.pdf`;
Â  Â  Â  document.body.appendChild(a);
Â  Â  Â  a.click();
Â  Â  Â  document.body.removeChild(a);
Â  Â  };

Â  Â  const btnRes=document.createElement('button');Â 
Â  Â  btnRes.className='btn btn-sm btn-primary';Â 
Â  Â  btnRes.textContent='Resolvido';
Â  Â  btnRes.onclick=async ()=>{ await patchDocRemote(x.proto,{status:'Resolvido'}); await docs(); renderTables(); };

Â  Â  td.appendChild(btnView);Â 
Â  Â  td.appendChild(btnRes);
Â  Â  anaTbody.appendChild(tr);
Â  });
}

document.getElementById('btnFilter').addEventListener('click', ()=> applyFilter());
document.getElementById('btnFilterAna').addEventListener('click', ()=> applyFilter(true));
async function applyFilter(analista=false){
Â  await docs();
Â  const d=_docsCache;
Â  const p=(analista?document.getElementById('aPaciente').value:document.getElementById('fPaciente').value).trim().toLowerCase();
Â  const m=(analista?document.getElementById('aMedico').value:document.getElementById('fMedico').value).trim().toLowerCase();
Â  const pr=(analista?document.getElementById('aProto').value:document.getElementById('fProto').value).trim().toLowerCase();
Â  const stSel=(analista?document.getElementById('aStatus').value:document.getElementById('fStatus').value);
Â  const tbody=document.getElementById(analista?'anaTable':'logTable'); tbody.innerHTML='';

Â  let list=d.filter(x=>{
Â  Â  if(p && !x.paciente.toLowerCase().includes(p)) return false;
Â  Â  if(m && !x.medico.toLowerCase().includes(m)) return false;
Â  Â  if(pr && !x.proto.toLowerCase().includes(pr)) return false;
Â  Â  if(stSel && stSel!=='TODOS' && x.status!==stSel) return false;
Â  Â  return true;
Â  });
Â  if(stSel==='TODOS'){
Â  Â  list=list.filter(x=> analista ? x.status!=='Recebido' : true);
Â  }

Â  list.forEach(x=>{
Â  Â  const tr=document.createElement('tr');
Â  Â  tr.innerHTML=`<td>${x.proto}</td><td>${x.paciente}</td><td>${x.medico}</td><td>${x.hospital}</td><td>${x.convenio}</td><td>${statusBadge(x.status)}</td><td></td>`;
Â  Â  const td=tr.querySelector('td:last-child');

Â  Â  const btnView=document.createElement('button');Â 
Â  Â  btnView.className='btn btn-sm btn-outline-secondary me-1';Â 
Â  Â  btnView.textContent='Ver PDF';

Â  Â  if (x.url) {
Â  Â  Â  const aOnline = document.createElement('a');
Â  Â  Â  aOnline.href = x.url;
Â  Â  Â  aOnline.target = '_blank';
Â  Â  Â  aOnline.className = 'btn btn-sm btn-outline-success me-1';
Â  Â  Â  aOnline.textContent = 'Ver PDF (online)';
Â  Â  Â  td.appendChild(aOnline);
Â  Â  }

Â  Â  btnView.onclick=()=>{Â 
Â  Â  Â  let url = window._pdfStore[x.proto];Â 
Â  Â  Â  if(!url && x.url){ window.open(x.url, '_blank'); return; }
Â  Â  Â  if(!url){ alert('PDF nÃ£o encontrado nesta sessÃ£o. Use "Ver PDF (online)".'); return; }
Â  Â  Â  const a = document.createElement('a');
Â  Â  Â  a.href = url;
Â  Â  Â  a.download = `${x.paciente}_${x.proto}.pdf`;
Â  Â  Â  document.body.appendChild(a);
Â  Â  Â  a.click();
Â  Â  Â  document.body.removeChild(a);
Â  Â  };

Â  Â  td.appendChild(btnView);

Â  Â  if(x.status==='Recebido' && !analista){
Â  Â  Â  const btnFin=document.createElement('button'); btnFin.className='btn btn-sm btn-success'; btnFin.textContent='Finalizar';
Â  Â  Â  btnFin.onclick=async ()=>{ await patchDocRemote(x.proto,{status:'Finalizado'}); await docs(); renderTables(); };
Â  Â  Â  td.appendChild(btnFin);
Â  Â  } else if(x.status==='Finalizado' && analista){
Â  Â  Â  const btnRes=document.createElement('button'); btnRes.className='btn btn-sm btn-primary'; btnRes.textContent='Resolvido';
Â  Â  Â  btnRes.onclick=async ()=>{ await patchDocRemote(x.proto,{status:'Resolvido'}); await docs(); renderTables(); };
Â  Â  Â  td.appendChild(btnRes);
Â  Â  }
Â  Â  tbody.appendChild(tr);
Â  });
}

/* ======= ADMIN â€” Gerenciar usuÃ¡rios ======= */
async function renderUsersTable(){
Â  const tb=document.getElementById('usersTable'); if(!tb) return; tb.innerHTML='';
Â  await users();
Â  _usersCache.forEach(u=>{
Â  Â  const tr=document.createElement('tr');
Â  Â  const roleLabel = u.role==='rep'?'REP':u.role==='instr'?'INSTR':u.role==='log'?'LOG':u.role==='ana'?'ANA':'ADMIN';
Â  Â  tr.innerHTML=`<td>${u.nome}</td><td>${u.email}</td><td>${roleLabel}</td><td>${u.ativo!==false?'Ativo':'Inativo'}</td><td></td>`;
Â  Â  const td=tr.querySelector('td:last-child');
Â  Â  const btnToggle=document.createElement('button'); btnToggle.className='btn btn-sm ' + (u.ativo!==false?'btn-outline-warning':'btn-outline-success');
Â  Â  btnToggle.textContent = u.ativo!==false ? 'Inativar' : 'Ativar';
Â  Â  btnToggle.onclick=async ()=>{
Â  Â  Â  await toggleUserActive(u.email);
Â  Â  Â  renderUsersTable();
Â  Â  };
Â  Â  td.appendChild(btnToggle);
Â  Â  tb.appendChild(tr);
Â  });
}

document.getElementById('btnCriarUsuario').addEventListener('click', async ()=>{
Â  const nome=document.getElementById('uNome').value.trim();
Â  const email=document.getElementById('uEmail').value.trim();
Â  const senha=document.getElementById('uSenha').value.trim();
Â  const role=document.getElementById('uRole').value;
Â  if(!nome||!email||!senha){ alert('Preencha nome, e-mail e senha.'); return; }
Â  try{
Â  Â  const list = await users();
Â  Â  if(list.some(x=>x.email.toLowerCase()===email.toLowerCase())){ alert('JÃ¡ existe usuÃ¡rio com este e-mail.'); return; }
Â  Â  await createUserRemote({ nome, email, senha, role });
Â  Â  document.getElementById('uNome').value=''; document.getElementById('uEmail').value=''; document.getElementById('uSenha').value='';
Â  Â  renderUsersTable();
Â  Â  alert('UsuÃ¡rio criado!');
Â  }catch(e){ alert(e.message); }
});

document.getElementById('btnExportar').addEventListener('click', async ()=>{
Â  await users();
Â  const blob=new Blob([JSON.stringify(_usersCache,null,2)],{type:'application/json'});
Â  const url=URL.createObjectURL(blob);
Â  const a=document.createElement('a'); a.href=url; a.download='usuarios.json'; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('inpImportar').addEventListener('change', async (e)=>{
Â  const file=e.target.files[0]; if(!file) return;
Â  const text=await file.text(); let arr=[];
Â  try{
Â  Â  arr=JSON.parse(text); if(!Array.isArray(arr)) throw new Error('JSON invÃ¡lido');
Â  }catch(err){ alert('Arquivo invÃ¡lido'); return; }
Â  try{
Â  Â  for(const u of arr){
Â  Â  Â  try{ await createUserRemote(u); }catch(_){} // ignora duplicados
Â  Â  }
Â  Â  renderUsersTable(); alert('Importado com sucesso!');
Â  }catch(err){ alert('Falha ao importar'); }
});

/* ======= RESTORE SESSION ======= */
const curr = JSON.parse(sessionStorage.getItem('mvp_user') || 'null');
if(curr){ setView(curr); } else { boot(); }

window.addEventListener('error', e => console.error('JS Error:', e.message, e)); // debug
window.addEventListener('unhandledrejection', e => console.error('Promise Rejection:', e.reason)); // debug

</script>
</body>
</html>